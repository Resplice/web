<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=1, height=1, initial-scale=1.0, user-scalable=no" />
		<meta name="robots" content="noindex" />
	</head>
	<script>
		async function deleteDatabase() {
			return new Promise((resolve, reject) => {
				const request = indexedDB.deleteDatabase('RESPLICE_CACHE')
				request.onsuccess = () => {
					resolve()
				}
				request.onerror = (e) => {
					reject(e)
				}
			})
		}
		async function createDatabase(sessionData) {
			return new Promise((resolve, reject) => {
				const request = indexedDB.open('RESPLICE_CACHE', 1)

				request.onupgradeneeded = () => {
					const db = request.result
					db.createObjectStore('session')
					db.createObjectStore('commands', { autoIncrement: true })
				}

				request.onsuccess = () => {
					const txn = request.result.transaction(['session', 'commands'], 'readwrite')
					txn.objectStore('session').put(sessionData, 1)
					for (let i = 1; i < sessionData.initialCommandId; i++) {
						txn.objectStore('commands').add(`authCommand: ${i}`)
					}
					resolve()
				}

				request.onerror = (e) => {
					reject(e)
				}
			})
		}
		window.addEventListener('message', async (event) => {
			// TODO: Check event.origin
			// if (event.origin !== 'https://auth.resplice.com') {
			// 	return
			// }

			await deleteDatabase()
			await createDatabase(event.data)

			event.source.postMessage('OK', event.origin)
		})
	</script>
</html>
